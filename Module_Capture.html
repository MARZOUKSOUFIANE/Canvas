<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Capture d'image</title>   
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <style>
     canvas{
     }
     button{
        margin-left: 300px;
     }

     label{
         margin-left: 20px;
     }
     div{
         margin-bottom: 50px;
     }
    </style>
</head>
<body>
    <video controls width="400" height="400" id="V1">
        <source></source>
    </video>

    <canvas id="C1"></canvas>

    <p></p>

    <button id="b1" ><a href="#"><img src="camara.png" width="50" height="50"></a></img></button> 
    <button id="b2" ><a  href="#" download="capture" id="link">
        <img src="download.png" width="50" height="50"><br>64
      </a></button>

      <br><br><br><br><br>
      <div style="border: 1px solid gray">
        <br><br>
      <label for="opacity">Opacity</label>
      <input type="range" name="opacity" min="0" max="100" step="33" value="0" id="opacity" onchange="opacity()">

      <label for="scale">Scale</label>
      <input type="range" name="scale" min="0" max="100" step="33" value="0" id="scale" onchange="scale()">

      <label for="sepia">Sepia</label>
      <input type="range" name="sepia" min="0" max="100" step="33" value="0" id="sepia" onchange="sepia()">

      <br><br>
      <button id="b3" ><a  href="#" id="save" onclick="save()">
            <img src="save.png" width="40" height="40">
          </a></button >

      <br><br>    
    </div>
    <script>

var count = 3; 

        function setup() {
            this.canvas=document.querySelector('#C1')
            this.video=document.querySelector('#V1');
            this.buton=document.querySelector('#b1')
            this.buton2=document.querySelector('#b2')
            this.ctx=this.canvas.getContext('2d')
            this.canvas.width=this.video.width
            this.canvas.height=this.video.height
            display_camera()
            this.video.addEventListener('play', _ => {
                this.buton.addEventListener('click',_ => {
                    anim();
                })
                this.buton2.addEventListener('click',_ => {
                    download();
                })
            })
        }

    async function display_camera() {
        this.video=document.querySelector('#V1');
            let stream 
            try {
               stream = await navigator.mediaDevices.getUserMedia({video: true})
                this.video.srcObject = stream
            } catch (error) {
                console.log(error)
            }
    }   
    

    function take_image() {
    this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height)
    }
    
function anim() {
    if (count >= 0) {
        this.ctx.font = "30px Arial"
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height)
        this.ctx.fillText('. . . '+count,this.canvas.width/2,this.canvas.height/2)
        count--;
        setTimeout(anim, 1000);
    }
    else {
        take_image()
    }
}

function download(){
    //convert canvas content to Base64 
    this.imgBase64=this.canvas.toDataURL()
    this.image=new Image()
    this.image.src=this.imgBase64
    //le button download permet d'afficher le contenu de l'image en format Base64
    console.log(this.image)
}
 
    setup()

    function opacity() {
        var opacity=document.getElementById('opacity').value;
         if(opacity == 33){
            document.querySelector('canvas').classList.remove('w3-opacity');
            document.querySelector('canvas').classList.remove('w3-opacity-max');
            document.querySelector('canvas').classList.add('w3-opacity-min');
        }
        else if(opacity == 66){
            document.querySelector('canvas').classList.remove('w3-opacity-min');
            document.querySelector('canvas').classList.remove('w3-opacity-max');
            document.querySelector('canvas').classList.add('w3-opacity');
        }
        else if(opacity == 99){
            document.querySelector('canvas').classList.remove('w3-opacity-min');
            document.querySelector('canvas').classList.remove('w3-opacity');
            document.querySelector('canvas').classList.add('w3-opacity-max');
        }
        else{
            document.querySelector('canvas').classList.remove('w3-opacity-min');
            document.querySelector('canvas').classList.remove('w3-opacity');
            document.querySelector('canvas').classList.remove('w3-opacity-max');
        }
    }

    function scale() {
        var scale=document.getElementById('scale').value;
         if(scale == 33){
            document.querySelector('canvas').classList.add('w3-grayscale-min');
            document.querySelector('canvas').classList.remove('w3-grayscale');
            document.querySelector('canvas').classList.remove('w3-grayscale-max');
        }
        else if(scale == 66){
            document.querySelector('canvas').classList.remove('w3-grayscale-min');
            document.querySelector('canvas').classList.add('w3-grayscale');
            document.querySelector('canvas').classList.remove('w3-grayscale-max');
        }
        else if(scale == 99){
            document.querySelector('canvas').classList.remove('w3-grayscale-min');
            document.querySelector('canvas').classList.remove('w3-grayscale');
            document.querySelector('canvas').classList.add('w3-grayscale-max');
        }
        else{
            document.querySelector('canvas').classList.remove('w3-grayscale-min');
            document.querySelector('canvas').classList.remove('w3-grayscale');
            document.querySelector('canvas').classList.remove('w3-grayscale-max');
        }
    }

    function sepia() {
        var sepia=document.getElementById('sepia').value;
         if(sepia == 33){
            document.querySelector('canvas').classList.add('w3-sepia-min');
            document.querySelector('canvas').classList.remove('w3-sepia');
            document.querySelector('canvas').classList.remove('w3-sepia-max');
        }
        else if(sepia == 66){
            document.querySelector('canvas').classList.remove('w3-sepia-min');
            document.querySelector('canvas').classList.add('w3-sepia');
            document.querySelector('canvas').classList.remove('w3-sepia-max');
        }
        else if(sepia == 99){
            document.querySelector('canvas').classList.remove('w3-sepia-min');
            document.querySelector('canvas').classList.remove('w3-sepia');
            document.querySelector('canvas').classList.add('w3-sepia-max');
        }
        else{
            document.querySelector('canvas').classList.remove('w3-sepia-min');
            document.querySelector('canvas').classList.remove('w3-sepia');
            document.querySelector('canvas').classList.remove('w3-sepia-max');
        }
    }

    function save(){
    //convert canvas content to image jpeg 
    var canvas = document.querySelector("canvas");
    var img    = canvas.toDataURL("image/jpeg");
    //le button save permet d'afficher le contenu de l'image en format Base64
    console.log(img)
}
    
    </script>
</body>
</html>